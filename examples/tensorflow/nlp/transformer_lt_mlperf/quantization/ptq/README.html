<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Step-by-Step &mdash; Intel® Neural Compressor  documentation</title><link rel="stylesheet" href="../../../../../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../../../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../../../../../" src="../../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../../_static/jquery.js"></script>
        <script src="../../../../../../_static/underscore.js"></script>
        <script src="../../../../../../_static/doctools.js"></script>
    <script src="../../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../../../index.html" class="icon icon-home"> Intel® Neural Compressor
          </a>
              <div class="version">
                1.14.2
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../README.html">Intel® Neural Compressor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../docs/examples_readme.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../api-documentation/apis.html">APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../docs/doclist.html">Developer Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../docs/releases_info.html">Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../docs/contributions.html">Contribution Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../docs/legal_information.html">Legal Information</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/intel/neural-compressor">Intel® Neural Compressor repository</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../index.html">Intel® Neural Compressor</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../../index.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">Step-by-Step</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../../_sources/examples/tensorflow/nlp/transformer_lt_mlperf/quantization/ptq/README.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="step-by-step">
<h1>Step-by-Step<a class="headerlink" href="#step-by-step" title="Permalink to this headline">¶</a></h1>
<p>This document is used to list steps of reproducing TensorFlow Intel® Neural Compressor tuning zoo result of Transformer_LT_mlperf. Part of the inference code is based on the transformer mlperf evaluation code. Detailed information on mlperf benchmark can be found in <a class="reference external" href="https://github.com/mlperf/training/tree/master/translation/tensorflow/transformer">mlcommons/training</a>.
This example can run on Intel CPUs and GPUs.</p>
<div class="section" id="prerequisite">
<h2>Prerequisite<a class="headerlink" href="#prerequisite" title="Permalink to this headline">¶</a></h2>
<div class="section" id="installation">
<h3>1. Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install Intel® Neural Compressor</span>
pip install neural-compressor
</pre></div>
</div>
</div>
<div class="section" id="install-tensorflow">
<h3>2. Install TensorFlow<a class="headerlink" href="#install-tensorflow" title="Permalink to this headline">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pip install tensorflow
</pre></div>
</div>
<blockquote>
<div><p>Note: Supported Tensorflow <a class="reference external" href="../../../../../../README.html#validated-software-environment">Version</a>.</p>
</div></blockquote>
</div>
<div class="section" id="install-intel-extension-for-tensorflow">
<h3>3. Install Intel Extension for Tensorflow<a class="headerlink" href="#install-intel-extension-for-tensorflow" title="Permalink to this headline">¶</a></h3>
<div class="section" id="quantizing-the-model-on-intel-gpu">
<h4>Quantizing the model on Intel GPU<a class="headerlink" href="#quantizing-the-model-on-intel-gpu" title="Permalink to this headline">¶</a></h4>
<p>Intel Extension for Tensorflow is mandatory to be installed for quantizing the model on Intel GPUs.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pip install --upgrade intel-extension-for-tensorflow<span class="o">[</span>gpu<span class="o">]</span>
</pre></div>
</div>
<p>For any more details, please follow the procedure in <a class="reference external" href="https://github.com/intel-innersource/frameworks.ai.infrastructure.intel-extension-for-tensorflow.intel-extension-for-tensorflow/blob/master/docs/install/install_for_gpu.md#install-gpu-drivers">install-gpu-drivers</a></p>
</div>
<div class="section" id="quantizing-the-model-on-intel-cpu-experimental">
<h4>Quantizing the model on Intel CPU(Experimental)<a class="headerlink" href="#quantizing-the-model-on-intel-cpu-experimental" title="Permalink to this headline">¶</a></h4>
<p>Intel Extension for Tensorflow for Intel CPUs is experimental currently. It’s not mandatory for quantizing the model on Intel CPUs.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pip install --upgrade intel-extension-for-tensorflow<span class="o">[</span>cpu<span class="o">]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="prepare-dataset-frozen-model">
<h3>4. Prepare Dataset &amp; Frozen Model<a class="headerlink" href="#prepare-dataset-frozen-model" title="Permalink to this headline">¶</a></h3>
<p>Follow the <a class="reference external" href="https://github.com/IntelAI/models/blob/master/benchmarks/language_translation/tensorflow/transformer_mlperf/inference/fp32/README.md">instructions</a> on <a class="reference external" href="https://github.com/IntelAI/models">Model Zoo for Intel® Architecture</a> to download and preprocess the WMT English-German dataset and generate a FP32 frozen model. Please make sure there are the following files in the dataset directory and the input model directory.</p>
<ul class="simple">
<li><p>DATASET_DIR: newstest2014.de, newstest2014.en, vocab.ende.32768</p></li>
<li><p>INPUT_MODEL_DIR: the FP32 frozen model .pb file</p></li>
</ul>
</div>
</div>
<div class="section" id="run-command">
<h2>Run Command<a class="headerlink" href="#run-command" title="Permalink to this headline">¶</a></h2>
<div class="section" id="run-tuning">
<h3>Run Tuning:<a class="headerlink" href="#run-tuning" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>bash run_tuning.sh \
    --input_model=$INPUT_MODEL \
    --dataset_location=$DATASET_DIR \
    --output_model=$OUTPUT_MODEL \
    --file_out=$OUTPUT_TRANSLATION_FILE \
    --config=$CONFIG_FILE \
    --batch_size=$BATCH_SIZE \
    --warmup_steps=$WARMUPS \
    --bleu_variant=$VARIANT \
    --num_inter=$INTER_THREADS \
    --num_intra=$INTRA_THREADS
</pre></div>
</div>
</div>
<div class="section" id="run-benchmark">
<h3>Run Benchmark:<a class="headerlink" href="#run-benchmark" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># benchmark mode: only get performance
bash run_benchmark.sh \
    --input_model=$INPUT_MODEL \
    --dataset_location=$DATASET_DIR \
    --file_out=$OUTPUT_TRANSLATION_FILE \
    --mode=benchmark \
    --batch_size=$BATCH_SIZE \
    --iters=$ITERATIONS \
    --warmup_steps=$WARMUPS \
    --bleu_variant=$VARIANT \
    --num_inter=$INTER_THREADS \
    --num_intra=$INTRA_THREADS
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># accuracy mode: get performance and accuracy
bash run_benchmark.sh \
    --input_model=$INPUT_MODEL \
    --dataset_location=$DATASET_DIR \
    --file_out=$OUTPUT_TRANSLATION_FILE \
    --mode=accuracy \
    --batch_size=$BATCH_SIZE \
    --warmup_steps=$WARMUPS \
    --bleu_variant=$VARIANT \
    --num_inter=$INTER_THREADS \
    --num_intra=$INTRA_THREADS
</pre></div>
</div>
<p>Where (Default values are shown in the square brackets):</p>
<ul class="simple">
<li><p>$INPUT_MODEL [“./transformer_mlperf_fp32.pb”]– The path to input FP32 frozen model .pb file to load</p></li>
<li><p>$DATASET_DIR [“./transformer_uniform_data”]– The path to input dataset directory, which should include newstest2014.en, newstest2014.de and vocab.ende.32768</p></li>
<li><p>$OUTPUT_MODEL [“./output_transformer_mlperf_int8.pb”]– The user-specified export path to the output INT8 quantized model</p></li>
<li><p>$OUTPUT_TRANSLATION_FILE [“./output_translation_result.txt”] – The file path to save model translation result, only the most recent translation result will be saved</p></li>
<li><p>$CONFIG_FILE [“./transformer_lt_mlperf.yaml”]– The path to quantization configuration .yaml file to load for tuning</p></li>
<li><p>$BATCH_SIZE [64]– The batch size for model inference</p></li>
<li><p>$ITERATIONS [-1]– The user-defined total inference iterations in benchmark mode. If it is -1, it means to run the entire dataset</p></li>
<li><p>$WARMUPS [10]– The number of warmup steps before benchmarking the model</p></li>
<li><p>$VARIANT [“uncased”]– The case sensitive type to compute BLEU score, which is one of two options: ‘uncased’/’cased’</p></li>
<li><p>$INTER_THREADS [2]– The number of inter op parallelism thread to use, which can be set to the number of sockets</p></li>
<li><p>$INTRA_THREADS [28]– The number of intra op parallelism thread to use, which can be set to the number of physical core per socket</p></li>
</ul>
</div>
</div>
</div>
<div class="section" id="details-of-enabling-intel-neural-compressor-on-transformer-lt-mlperf-for-tensorflow">
<h1>Details of enabling Intel® Neural Compressor on Transformer_LT_mlperf for Tensorflow.<a class="headerlink" href="#details-of-enabling-intel-neural-compressor-on-transformer-lt-mlperf-for-tensorflow" title="Permalink to this headline">¶</a></h1>
<p>This is a tutorial of how to enable Transformer_LT_mlperf model with Intel® Neural Compressor.</p>
<div class="section" id="user-code-analysis">
<h2>User Code Analysis<a class="headerlink" href="#user-code-analysis" title="Permalink to this headline">¶</a></h2>
<ol class="simple">
<li><p>User specifies fp32 <em>model</em>, calibration dataset <em>q_dataloader</em>, evaluation dataset <em>eval_dataloader</em> and metric in tuning.metric field of model-specific yaml config file.</p></li>
<li><p>User specifies fp32 <em>model</em>, calibration dataset <em>q_dataloader</em> and a custom <em>eval_func</em> which encapsulates the evaluation dataset and metric by itself.</p></li>
</ol>
<p>For Transformer_LT_mlperf, we applied the latter one because we don’t have dataset and metric for Transformer_LT_mlperf. The task is to implement the <em>q_dataloader</em> and <em>eval_func</em>.</p>
<div class="section" id="q-dataloader-part-adaption">
<h3>q_dataloader Part Adaption<a class="headerlink" href="#q-dataloader-part-adaption" title="Permalink to this headline">¶</a></h3>
<p>Below dataset class uses getitem to provide the model with input.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Dataset</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="c1"># initialize dataset related info here</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="evaluation-part-adaption">
<h3>Evaluation Part Adaption<a class="headerlink" href="#evaluation-part-adaption" title="Permalink to this headline">¶</a></h3>
<p>We evaluate the model with BLEU score, its source: https://github.com/IntelAI/models/blob/master/models/language_translation/tensorflow/transformer_mlperf/inference/fp32/transformer/compute_bleu.py</p>
</div>
<div class="section" id="write-yaml-config-file">
<h3>Write Yaml config file<a class="headerlink" href="#write-yaml-config-file" title="Permalink to this headline">¶</a></h3>
<p>In examples directory, there is a transformer_lt_mlperf.yaml for tuning the model on Intel CPUs. The ‘framework’ in the yaml is set to ‘tensorflow’. If running this example on Intel GPUs, the ‘framework’ should be set to ‘tensorflow_itex’ and the device in yaml file should be set to ‘gpu’. The transformer_lt_mlperf_itex.yaml is prepared for the GPU case. We could remove most of items and only keep mandatory item for tuning. We also implement a calibration dataloader and have evaluation field for creation of evaluation function at internal neural_compressor.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">model</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">transformer_lt_mlperf</span>
  <span class="nt">framework</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">tensorflow</span>
  <span class="nt">inputs</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">input_tokens</span>
  <span class="nt">outputs</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">model/Transformer/strided_slice_15</span>

<span class="nt">device</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cpu</span>                                          <span class="c1"># optional. default value is cpu, other value is gpu.</span>

<span class="nt">quantization</span><span class="p">:</span>
  <span class="nt">calibration</span><span class="p">:</span>
    <span class="nt">sampling_size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">500</span>
  <span class="nt">model_wise</span><span class="p">:</span>
    <span class="nt">weight</span><span class="p">:</span>
      <span class="nt">granularity</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">per_channel</span>

<span class="nt">tuning</span><span class="p">:</span>
  <span class="nt">accuracy_criterion</span><span class="p">:</span>
    <span class="nt">relative</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.01</span>
  <span class="nt">exit_policy</span><span class="p">:</span>
    <span class="nt">timeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
    <span class="nt">max_trials</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">100</span>
  <span class="nt">random_seed</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">9527</span>
</pre></div>
</div>
<p>Here we set the input tensor and output tensors name into <em>inputs</em> and <em>outputs</em> field.
In this case we calibrate and quantize the model, and use our calibration dataloader initialized from a ‘Dataset’ object.</p>
</div>
<div class="section" id="code-update">
<h3>Code update<a class="headerlink" href="#code-update" title="Permalink to this headline">¶</a></h3>
<p>After prepare step is done, we add tune code to generate quantized model.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">neural_compressor.experimental</span> <span class="kn">import</span> <span class="n">Quantization</span><span class="p">,</span> <span class="n">common</span>
<span class="n">quantizer</span> <span class="o">=</span> <span class="n">Quantization</span><span class="p">(</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">input_file</span><span class="p">,</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">vocab_file</span><span class="p">)</span>
<span class="n">quantizer</span><span class="o">.</span><span class="n">calib_dataloader</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span>
                                               <span class="n">collate_fn</span> <span class="o">=</span> <span class="n">collate_fn</span><span class="p">,</span>
                                               <span class="n">batch_size</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
<span class="n">quantizer</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
<span class="n">quantizer</span><span class="o">.</span><span class="n">eval_func</span> <span class="o">=</span> <span class="n">eval_func</span>
<span class="n">q_model</span> <span class="o">=</span> <span class="n">quantizer</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">q_model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">FLAGS</span><span class="o">.</span><span class="n">output_model</span><span class="p">)</span>
</pre></div>
</div>
<p>The Intel® Neural Compressor quantizer.fit() function will return a best quantized model under time constraint.</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Intel® Neural Compressor.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>